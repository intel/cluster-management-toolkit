- hosts: selection
  vars:
    metadata:
      description: Prepare the host for using Ansible without a password
      playbook-types:
      - internal
      category: Setup
  gather_facts: yes
  become: True
  become_user: root
  tasks:
  - name: "Adding {{ ansible_user }} to sudoers"
    lineinfile:
      path: "/etc/sudoers.d/{{ ansible_user }}"
      regex: "^{{ ansible_user }}"
      line: "{{ ansible_user }} ALL=(ALL) NOPASSWD: ALL"
      state: present
      mode: "0660"
      create: yes
      validate: "visudo -cf %s"
  - name: "Adding public keys to authorized_keys"
    ansible.posix.authorized_key:
      user: "{{ ansible_user }}"
      state: present
      key: "{{ item }}"
    loop: "{{ authorized_keys }}"
