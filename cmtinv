#! /usr/bin/env python3
# Requires: python3 (>= 3.8)
# Requires: python3-natsort

"""
This program is used to query or modify the Ansible inventory

For usage, see:
	cmtinv help
"""

import errno
import os
from pathlib import Path, PurePath
import sys
from typing import cast, Dict, List, Optional, Tuple

try:
	from natsort import natsorted
except ModuleNotFoundError:
	sys.exit("ModuleNotFoundError: you probably need to install python3-natsort")

from cmttypes import deep_get, DictPath, FilePath
from cmtpaths import HOMEDIR, SSH_DIR
from cmtpaths import DEFAULT_THEME_FILE, KUBE_CONFIG_FILE

import cmtio
import cmtio_yaml

from commandparser import parse_commandline

from ansible_helper import ansible_configuration, ansible_get_inventory_pretty, ansible_get_inventory_dict, ansible_get_groups
from ansible_helper import ansible_get_groups_by_host, ansible_get_hosts_by_group, ansible_add_hosts
from ansible_helper import ansible_remove_hosts, ansible_remove_groups, ansible_set_vars
from ansible_helper import ansible_set_hostvars, ansible_set_groupvars, ansible_unset_hostvars
from ansible_helper import ansible_unset_groupvars, ansible_create_groups, ansible_ping
from ansible_helper import ANSIBLE_INVENTORY

import cmtlib
from cmtlib import read_cmtconfig

from ansithemeprint import ANSIThemeString, ansithemeprint

import about
PROGRAMDESCRIPTION = "Query or modify the host inventory"
PROGRAMAUTHORS = "Written by David Weinehall."

def set_host_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Set host-specific variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of key:value pairs, followed by comma-separated list of hosts
		Returns:
			0
	"""

	del options

	hostvars = []
	hosts = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no hosts provided")

	hosts = args[1].split(",")
	keyvals = args[0].split(",")

	for keyval in keyvals:
		try:
			key, value = keyval.split(":")
		except ValueError:
			ansithemeprint([ANSIThemeString("Error", "error"),
				  ANSIThemeString(": Setting a variable requires a ", "default"),
				  ANSIThemeString("KEY", "argument"),
				  ANSIThemeString(":", "separator"),
				  ANSIThemeString("VALUE ", "argument"),
				  ANSIThemeString("pair.", "default")], stderr = True)
			print()
			ansithemeprint([ANSIThemeString("Try “", "default"),
				  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"),
				  ANSIThemeString("help", "command"),
				  ANSIThemeString("“ for more information.", "default")], stderr = True)
			sys.exit(errno.EINVAL)
		hostvars.append((key, value))

	# Set vars
	if len(hostvars) > 0:
		retval = ansible_set_hostvars(inventory = ANSIBLE_INVENTORY, hosts = hosts, hostvars = hostvars)
		if retval == False:
			raise Exception(f"Programming error: failed to set vars for hosts {hosts}")

	return 0

def set_group_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Set group-specific variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of key:value pairs, followed by comma-separated list of groups
		Returns:
			0
	"""

	del options

	groupvars = []
	groups = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no groups provided")

	groups = args[1].split(",")
	keyvals = args[0].split(",")

	for keyval in keyvals:
		try:
			key, value = keyval.split(":")
		except ValueError:
			ansithemeprint([ANSIThemeString("Error", "error"),
				  ANSIThemeString(": Setting a variable requires a ", "default"),
				  ANSIThemeString("KEY", "argument"),
				  ANSIThemeString(":", "separator"),
				  ANSIThemeString("VALUE ", "argument"),
				  ANSIThemeString("pair.", "default")], stderr = True)
			print()
			ansithemeprint([ANSIThemeString("Try “", "default"),
				  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"),
				  ANSIThemeString("help", "command"),
				  ANSIThemeString("“ for more information.", "default")], stderr = True)
			sys.exit(errno.EINVAL)
		groupvars.append((key, value))

	# Set vars
	if len(groupvars) > 0:
		retval = ansible_set_groupvars(inventory = ANSIBLE_INVENTORY, groups = groups, groupvars = groupvars)
		if retval == False:
			raise Exception(f"Programming error: failed to set vars for groups {groups}")

	return 0

def set_global_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Set global variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of key:value pairs
		Returns:
			Return value from set_group_vars()
	"""

	return set_group_vars(options = options, args = [args[0], "all"])

def unset_host_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Unset host-specific variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of keys, followed by comma-separated list of hosts
		Returns:
			0
	"""

	del options

	hostvars = []
	hosts = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no hosts provided")

	hosts = args[1].split(",")
	hostvars = args[0].split(",")

	# Unset vars
	if len(hostvars) > 0:
		retval = ansible_unset_hostvars(inventory = ANSIBLE_INVENTORY, hosts = hosts, hostvars = hostvars)
		if retval == False:
			raise Exception(f"Programming error: failed to unset vars for hosts {hosts}")

	return 0

def unset_group_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Unset group-specific variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of keys, followed by comma-separated list of groups
		Returns:
			0
	"""

	del options

	groupvars = []
	groups = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no groups provided")

	groups = args[1].split(",")
	groupvars = args[0].split(",")

	# Unset vars
	if len(groupvars) > 0:
		retval = ansible_unset_groupvars(inventory = ANSIBLE_INVENTORY, groups = groups, groupvars = groupvars)
		if retval == False:
			raise Exception(f"Programming error: failed to unset vars for groups {groups}")

	return 0

def unset_global_vars(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Unset global variables

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): Comma-separated list of keys
		Returns:
			Return value from unset_group_vars()
	"""
	return unset_group_vars(options = options, args = [args[0], "all"])

def add_groups(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Add groups

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Comma-separated list of groups
		Returns:
			0
	"""

	groups = []
	groupvars = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no groups provided")

	groups = args[0].split(",")

	# We should not try to add "all" (it may cause unexpected issues with variables)
	if "all" in groups:
		ansithemeprint([ANSIThemeString("Warning", "warning"),
			  ANSIThemeString(": Ignoring attempt to add group “", "default"), ANSIThemeString("all", "argument"), ANSIThemeString("“.", "default")], stderr = True)
		groups.remove("all")
		if len(groups) == 0:
			return 0

	for opt, optarg in options:
		if opt == "--vars":
			tmp = optarg.split(",")
			for var in tmp:
				key, value = var.split(":")
				groupvars.append((key, value))
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	# Add the groups
	retval = ansible_create_groups(inventory = ANSIBLE_INVENTORY, groups = groups)

	if retval == False:
		raise Exception(f"Programming error: failed to add {groups} to inventory")

	# Set vars
	if len(groupvars) > 0:
		retval = ansible_set_groupvars(inventory = ANSIBLE_INVENTORY, groups = groups, groupvars = groupvars)
		if retval == False:
			raise Exception(f"Programming error: failed to set vars {groupvars} for groups {groups}")

	return 0

def add_hosts(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Add hosts

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Comma-separated list of hosts
		Returns:
			0
	"""

	groups = []
	hostvars = []
	hosts = []

	if args is None or len(args) == 0:
		raise Exception("Programming error; no hosts provided")

	hosts = args[0].split(",")

	if len(args) > 1:
		groups = args[1].split(",")

	for opt, optarg in options:
		if opt == "--vars":
			tmp = optarg.split(",")
			for var in tmp:
				key, value = var.split(":")
				hostvars.append((key, value))
		elif opt == "--groups":
			if len(groups) > 0:
				ansithemeprint([ANSIThemeString("Error", "error"), ANSIThemeString(": Invalid option; “", "default"),
					  ANSIThemeString(f"{opt}", "option"),
					  ANSIThemeString("“ cannot be used with ", "default"),
					  ANSIThemeString("HOST", "argument"), ANSIThemeString(",", "separator"), ANSIThemeString("... ", "argument"),
					  ANSIThemeString("GROUP", "argument"), ANSIThemeString(",", "separator"), ANSIThemeString("... ", "argument"),
					  ANSIThemeString("syntax.", "default")], stderr = True)
				print()
				ansithemeprint([ANSIThemeString("Try “", "default"),
					  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"), ANSIThemeString("help", "command"),
					  ANSIThemeString("“ for more information.", "default")], stderr = True)
				sys.exit(errno.EINVAL)
			groups = optarg.split(",")
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	retval = True
	# Add the host to every specified group
	if len(groups) == 0:
		retval = ansible_add_hosts(inventory = ANSIBLE_INVENTORY, hosts = hosts, skip_all = False)

		if retval == False:
			raise Exception(f"Programming error: failed to add {hosts}")
	else:
		group = ""

		for group in groups:
			retval = ansible_add_hosts(inventory = ANSIBLE_INVENTORY, hosts = hosts, group = group, skip_all = False)

		if retval == False:
			raise Exception(f"Programming error: failed to add {hosts} to group {group}")

	# Set vars
	if len(hostvars) > 0:
		retval = ansible_set_hostvars(inventory = ANSIBLE_INVENTORY, hosts = hosts, hostvars = hostvars)
		if retval == False:
			raise Exception(f"Programming error: failed to set vars for hosts {hosts}")

	return 0

def format_members(group: str, members: List[str]) -> List[ANSIThemeString]:
	"""
	Format a list of group members as a themearray

		Parameters:
			group (str): The name of the group
			members (list[str]): A list of hostnames
		Returns:
			formatted (list[ANSIThemeString]): A themearray
	"""

	formatted = [ANSIThemeString(f"{group}: ", "default")]
	i = 0
	for i, member in enumerate(members):
		if i < len(members) - 1:
			formatted += [ANSIThemeString(member, "yaml_key"),
				      ANSIThemeString(", ", "separator")]
		else:
			formatted += [ANSIThemeString(member, "yaml_key")]

	return formatted

def remove_groups(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Remove groups

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Comma-separated list of groups
		Returns:
			0
	"""

	groups = []
	extrahosts = []
	forceneeded = False
	force = False

	if args is None or len(args) == 0:
		raise Exception("Programming error; no groups provided")

	groups = args[0].split(",")

	for opt, _optarg in options:
		if opt == "--force":
			force = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	if "all" in groups:
		ansithemeprint([ANSIThemeString("Error", "error"),
			  ANSIThemeString(": The group “", "default"), ANSIThemeString("all", "argument"), ANSIThemeString("“ cannot be removed.", "default")], stderr = True)
		print()
		ansithemeprint([ANSIThemeString("Try “", "default"),
			  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"), ANSIThemeString("help", "command"),
			  ANSIThemeString("“ for more information.", "default")], stderr = True)
		sys.exit(errno.EINVAL)

	for group in groups:
		grouphosts = ansible_get_hosts_by_group(ANSIBLE_INVENTORY, group)
		if len(grouphosts) > 0:
			forceneeded = True
			extrahosts.append((group, grouphosts))

	if forceneeded == True and force == False:
		if forceneeded == True:
			ansithemeprint([ANSIThemeString("Error", "error"), ANSIThemeString(": The following groups are non-empty:", "default")])
			for group, hosts in extrahosts:
				ansithemeprint(format_members(group, hosts))
		print()
		ansithemeprint([ANSIThemeString("Removing groups that still contain hosts requires specifying “", "default"),
			  ANSIThemeString("--force", "option"), ANSIThemeString("“.", "default")], stderr = True)
		print()
		ansithemeprint([ANSIThemeString("Try “", "default"),
			  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"), ANSIThemeString("help", "command"),
			  ANSIThemeString("“ for more information.", "default")], stderr = True)
		sys.exit(errno.EINVAL)

	retval = ansible_remove_groups(inventory = ANSIBLE_INVENTORY, groups = groups, force = force)

	if retval == False:
		raise Exception(f"Programming error: failed to remove {groups}")

	return 0

def get_cluster_name() -> Optional[str]:
	"""
	Return the name of the cluster
		Returns:
			cluster_name (str): On success
			None (None): On failure
	"""

	try:
		d1 = cmtio_yaml.secure_read_yaml(KUBE_CONFIG_FILE)
	except FileNotFoundError:
		return None

	current_context = d1.get("current-context", None)
	if current_context is None:
		return None

	cluster_name = None

	for context in d1.get("contexts", []):
		if context.get("name", "") == current_context:
			cluster_name = context["context"].get("cluster", None)
			break

	return cluster_name

def rebuild_inventory(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Build an inventory based on information from Kubernetes

		Parameters:
			options (list[(opt, optarg)]): A list of opt, optarg
			args (list[str]): Unused
		Returns:
			0
	"""

	del args

	force = False

	for opt, _optarg in options:
		if opt == "--force":
			force = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	# Is there a pre-existing inventory?
	if Path(ANSIBLE_INVENTORY).is_file() and force == False:
		ansithemeprint([ANSIThemeString("Error", "error"), ANSIThemeString(": Overwriting an existing inventory requires specifying “", "default"),
			  ANSIThemeString("--force", "option"), ANSIThemeString("“.", "default")], stderr = True)
		print()
		ansithemeprint([ANSIThemeString("Try “", "default"),
			  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"), ANSIThemeString("help", "command"),
			  ANSIThemeString("“ for more information.", "default")], stderr = True)
		sys.exit(errno.EINVAL)

	# We ideally want to iterate over all clusters here, but for now we only import the current-context
	from kubernetes_helper import KubernetesHelper # pylint: disable=import-outside-toplevel
	cluster_name = get_cluster_name()
	if cluster_name is None:
		ansithemeprint([ANSIThemeString("Error", "error"),
			  ANSIThemeString(": Could not obtain cluster name; do you have a cluster available? Aborting.", "default")], stderr = True)
		sys.exit(errno.ENOENT)
	kh = KubernetesHelper(about.PROGRAM_SUITE_NAME, about.PROGRAM_SUITE_VERSION, None)

	vlist, status = kh.get_list_by_kind_namespace(("Node", ""), "")
	if status != 200:
		ansithemeprint([ANSIThemeString("Error", "error"),
			  ANSIThemeString(": API-server returned ", "default"),
			  ANSIThemeString(f"{status}", "errorvalue"),
			  ANSIThemeString("; aborting.", "default")], stderr = True)
		sys.exit(errno.EINVAL)
	if vlist is None:
		ansithemeprint([ANSIThemeString("Error", "error"),
			  ANSIThemeString(": API-server did not return any data", "default")], stderr = True)
		sys.exit(errno.EINVAL)

	for node in vlist:
		roles = kh.get_node_roles(cast(Dict, node))
		if "control-plane" in roles:
			groups = ["all", "controlplane", cluster_name]
		else:
			groups = ["all", "nodes", cluster_name]

		group = ""
		hosts = [deep_get(node, DictPath("metadata#name"))]
		retval = True
		for group in groups:
			retval = ansible_add_hosts(inventory = ANSIBLE_INVENTORY, hosts = hosts, group = group, skip_all = False)

		if retval == False:
			raise Exception(f"Programming error: failed to add {hosts} to group {group}")

	# Finally import the hostkey into authorized_keys
	pubkey = None

	tmp = cmtio.secure_read_string(FilePath(str(PurePath(SSH_DIR).joinpath("id_ecdsa.pub"))))
	if tmp is not None:
		tmplines = tmp.splitlines()
		pubkey = tmplines[0]

	if pubkey is None or len(pubkey) == 0:
		ansithemeprint([ANSIThemeString("Error", "error"),
			  ANSIThemeString(": Failed to read ", "default"),
			  ANSIThemeString(f"{HOMEDIR}/.ssh/id_ecdsa.pub", "path"),
			  ANSIThemeString("; aborting.", "default")], stderr = True)
		sys.exit(errno.ENOENT)

	values = {
		"authorized_keys": [pubkey],
	}
	ansible_set_vars(ANSIBLE_INVENTORY, "all", values)

	return 0

def remove_hosts(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Remove hosts

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Comma-separated list of hosts
		Returns:
			0
	"""

	hosts = []
	groups = ["all"]
	extragroups = []
	forceneeded = False
	force = False

	if args is None or len(args) == 0:
		raise Exception("Programming error; no hosts provided")

	hosts = args[0].split(",")

	if len(args) > 1:
		groups = args[1].split(",")

		# This returns a YAML tree with the inventory of nodes
		inventory_dict = ansible_get_inventory_dict()

		# If the hosts are only members of "all"
		# (or are not in the inventory at all),
		# it is OK to remove them without --force.
		#
		# All hosts are members of the groups "all";
		# this means that if len(hostgroups) > 1
		# we have auxilliary groups and --force is needed.
		for host in hosts:
			hostgroups = ansible_get_groups_by_host(inventory_dict, host)
			if len(hostgroups) > 1:
				forceneeded = True
				hostgroups.remove("all")
				extragroups.append((host, hostgroups))

	for opt, _optarg in options:
		if opt == "--force":
			force = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	if "all" in groups and forceneeded == True and (force == False or len(groups) > 1):
		if forceneeded == True:
			ansithemeprint([ANSIThemeString("Error", "error"),
				  ANSIThemeString(": The following hosts are parts of other groups than “", "default"),
				  ANSIThemeString("all", "argument"), ANSIThemeString("“:", "default")])
			for host, groups in extragroups:
				ansithemeprint(format_members(host, groups))
		print()
		ansithemeprint([ANSIThemeString("Removing hosts from “", "default"),
			  ANSIThemeString("all", "argument"),
			  ANSIThemeString("“ requires specifying “", "default"), ANSIThemeString("--force", "option"), ANSIThemeString("“", "default")], stderr = True)
		ansithemeprint([ANSIThemeString("unless “", "default"),
			  ANSIThemeString("all", "argument"),
			  ANSIThemeString("“ is the only group or the hosts are not members of other groups.", "default")], stderr = True)
		print()
		ansithemeprint([ANSIThemeString("Try “", "default"),
			  ANSIThemeString(f"{about.INVENTORY_PROGRAM_NAME} ", "programname"), ANSIThemeString("help", "command"),
			  ANSIThemeString("“ for more information.", "default")], stderr = True)
		sys.exit(errno.EINVAL)

	retval = True

	# If groups is ["all"] and "force" is specified we need to substitute ["all"] for a list of all groups
	if groups == ["all"]:
		groups = ansible_get_groups(inventory = ANSIBLE_INVENTORY)

	for group in groups:
		retval = ansible_remove_hosts(inventory = ANSIBLE_INVENTORY, hosts = hosts, group = group)

		if retval == False:
			raise Exception(f"Programming error: failed to remove {hosts} to group {group}")

	return 0

def inventory(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Show the inventory

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Comma-separated list of groups (optional)
		Returns:
			0
	"""

	include_groupvars = False
	include_hostvars = False

	for opt, _optarg in options:
		if opt == "--include-vars":
			include_groupvars = True
			include_hostvars = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	groups = None

	if args is not None and len(args) > 0:
		groups = args[0].split(",")

	for item in ansible_get_inventory_pretty(groups = groups, highlight = True, include_groupvars = include_groupvars, include_hostvars = include_hostvars):
		ansithemeprint(item)

	return 0

def list_groups(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	List groups

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Unused
		Returns:
			0
	"""

	del args

	include_groupvars = False

	for opt, _optarg in options:
		if opt == "--include-vars":
			include_groupvars = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	for item in ansible_get_inventory_pretty(groups = None, highlight = True, include_groupvars = include_groupvars, include_hosts = False):
		ansithemeprint(item)

	return 0

def list_hosts(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	List hosts

		Parameters:
			options (list[(str, str)]): List of opt, optarg
			args (list[str]): Unused
		Returns:
			0
	"""

	del args

	include_hostvars = False

	for opt, _optarg in options:
		if opt == "--include-vars":
			include_hostvars = True
		else:
			raise Exception(f"Programming error; invalid option {opt}")

	groups = ["all"]

	for item in ansible_get_inventory_pretty(groups = groups, highlight = True, include_hostvars = include_hostvars):
		ansithemeprint(item)

	return 0

def ping(options: List[Tuple[str, str]], args: List[str]) -> int:
	"""
	Ping hosts or groups of hosts
	Default: ping all hosts
	A well-formed inventory should not have groups with the same name as any of the hosts,
	thus mixing group and host names should be OK; but if there are overlaps the group
	are prioritised over the hostname

		Parameters:
			options (list[(str, str)]): Unused
			args (list[str]): list of hosts or groups (optional)
		Returns:
			0
	"""

	del options

	hoststatuses = []

	if args is not None and len(args) > 0:
		groups_or_hosts = args[0].split(",")
		selection = []
		_all = ansible_get_hosts_by_group(ANSIBLE_INVENTORY, "all")
		for group_or_host in groups_or_hosts:
			# First check if there's a group by this name
			hosts = ansible_get_hosts_by_group(ANSIBLE_INVENTORY, group_or_host)
			# If the group is empty let's try to see if it is a host
			if len(hosts) == 0:
				if group_or_host in _all:
					selection.append(group_or_host)
				else:
					ansithemeprint([ANSIThemeString("Warning", "warning"),
						  ANSIThemeString(": Skipping unknown host or group “", "default"),
						  ANSIThemeString(group_or_host, "argument"),
						  ANSIThemeString("“", "default")], stderr = True)
			else:
				selection += hosts
		# Eliminate duplicates
		selection = list(set(selection))
	else:
		selection = ansible_get_hosts_by_group(ANSIBLE_INVENTORY, "all")

	print("Please stand by, attempting to ping hosts")
	print()

	output = ansible_ping(selection = selection)

	if output is None or len(output) == 0:
		raise Exception("Internal error; ansible -m ping failed")

	maxlen = 0

	# This needs to be improved; if there's a message we need to tell the difference
	# between "Permission denied" and "No route to host"
	for (host, status) in cast(List[Tuple[str, str]], natsorted(output)):
		maxlen = max(len(host), maxlen)
		status_group = "error"

		if status == "SUCCESS":
			status_group = "success"
		elif status == "COULD NOT RESOLVE":
			status_group = "critical"
		elif status == "MISSING INTERPRETER?":
			status_group = "warning"
		elif status in ("UNKNOWN", "UNKNOWN ERROR"):
			status_group = "unknown"

		hoststatuses.append((host, status, status_group))

	header = "Hostname:"

	maxlen = max(maxlen, len(header))

	if len(hoststatuses) > 0:
		ansithemeprint([ANSIThemeString(header, "header"),
			  ANSIThemeString(f"{''.ljust(maxlen - len(header))}  ", "default"),
			  ANSIThemeString("Status:", "header")])

		for hostname, status, status_group in hoststatuses:
			ansithemeprint([ANSIThemeString(f"{hostname.ljust(maxlen)}  ", "default"),
				  ANSIThemeString(f"{status}", status_group)])

	return 0

COMMANDLINE = {
	"Add Groups": {
		"command": ["add-group", "add-groups"],
		"values": [ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Add ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" to inventory", "description")],
		"options": {
			"--vars": {
				"values": [ANSIThemeString("KEY", "argument"),
					   ANSIThemeString(":", "separator"),
					   ANSIThemeString("VALUE", "argument"),
					   ANSIThemeString(",", "separator"),
					   ANSIThemeString("...", "argument")],
				"description": [ANSIThemeString("Set these group variables", "description")],
				"requires_arg": True,
			},
		},
		"min_args": 1,
		"max_args": 1,
		"callback": add_groups,
	},
	"Add Hosts to Inventory": {
		"command": ["add-host", "add-hosts"],
		"values": [ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Add ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" to inventory", "description")],
		"options": {
			"--groups": {
				"values": [ANSIThemeString("GROUP", "argument"),
					   ANSIThemeString(",", "separator"),
					   ANSIThemeString("...", "argument")],
				"description": [ANSIThemeString("Add the hosts to these groups", "description")],
				"requires_arg": True,
			},
			"--vars": {
				"values": [ANSIThemeString("KEY", "argument"),
					   ANSIThemeString(":", "separator"),
					   ANSIThemeString("VALUE", "argument"),
					   ANSIThemeString(",", "separator"),
					   ANSIThemeString("...", "argument")],
				"description": [ANSIThemeString("Set these host variables", "description")],
				"requires_arg": True,
			},
		},
		"min_args": 1,
		"max_args": 2,
		"callback": add_hosts,
	},
	# This is purely for the benefit of the helptext generator
	"Add Hosts to Groups": {
		"command": ["add-host", "add-hosts"],
		"values": [ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("... ", "argument"),
			   ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Add ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" to ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
	},
	"Inventory": {
		"command": ["inventory", "inv"],
		"values": [ANSIThemeString("[", "separator"),
			   ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument"),
			   ANSIThemeString("]", "separator")],
		"description": [ANSIThemeString("Show inventory, optionally limited to ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"options": {
			"--include-vars": {
				"description": [ANSIThemeString("Show variables", "description")],
			},
		},
		"min_args": 0,
		"max_args": 1,
		"callback": inventory,
	},
	"List Hosts": {
		"command": ["list-hosts"],
		"description": [ANSIThemeString("List all hosts", "description")],
		"options": {
			"--include-vars": {
				"description": [ANSIThemeString("Show host variables", "description")],
			},
		},
		"min_args": 0,
		"max_args": 0,
		"callback": list_hosts,
	},
	"List Groups": {
		"command": ["list-groups"],
		"description": [ANSIThemeString("List all groups", "description")],
		"options": {
			"--include-vars": {
				"description": [ANSIThemeString("Show group variables", "description")],
			},
		},
		"min_args": 0,
		"max_args": 0,
		"callback": list_groups,
	},
	"Ping": {
		"command": ["ping"],
		"values": [ANSIThemeString("[", "separator"),
			   ANSIThemeString("GROUP/HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument"),
			   ANSIThemeString("]", "separator")],
		"description": [ANSIThemeString("Ansible ping ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" or ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" (Default: “", "description"),
				ANSIThemeString("all", "argument"),
				ANSIThemeString("“)", "description")],
		"min_args": 0,
		"max_args": 1,
		"callback": ping,
	},
	"Rebuild Inventory": {
		"command": ["rebuild-inventory"],
		"description": [ANSIThemeString("Create inventory for an existing Kubernetes cluster", "description")],
		"extended_description": [
			[ANSIThemeString("In cases where the cluster has not been setup using ", "description"),
			 ANSIThemeString(f"{about.PROGRAM_SUITE_NAME}", "programname")],
			[ANSIThemeString("this can be used to build a barebones inventory.", "description")],
			[ANSIThemeString("Note", "note"),
			 ANSIThemeString(": This requires a running cluster.", "description")],
		],
		"options": {
			"--force": {
				"description": [ANSIThemeString("Allow an ", "description"),
					        ANSIThemeString("existing", "underline"),
						ANSIThemeString(" inventory to be overwritten", "description")],
			},
		},
		"min_args": 0,
		"max_args": 0,
		"callback": rebuild_inventory,
	},
	"Remove Groups": {
		"command": ["remove-group", "remove-groups"],
		"values": [ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Remove ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" from inventory", "description")],
		"extended_description": [
			[ANSIThemeString("Note", "note"),
			 ANSIThemeString(": Removing the group “", "description"),
			 ANSIThemeString("all", "argument"),
			 ANSIThemeString("“ is not permitted", "description")],
		],
		"options": {
			"--force": {
				"description": [ANSIThemeString("Allow removal of ", "description"),
						ANSIThemeString("non-empty", "underline"),
						ANSIThemeString(" groups", "description")],
			},
		},
		"min_args": 1,
		"max_args": 1,
		"callback": remove_groups,
	},
	"Remove Hosts from ALL Groups": {
		"command": ["remove-host", "remove-hosts"],
		"values": [ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("... ", "argument"),
			   ANSIThemeString("all", "argument")],
		"description": [ANSIThemeString("Remove ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" from the inventory", "description")],
		"options": {
			"--force": {
				"description": [ANSIThemeString("Allow ", "description"),
						ANSIThemeString("complete", "underline"),
						ANSIThemeString(" removal of hosts from the inventory", "description")],
			},
		},
		"min_args": 2,
		"max_args": 2,
		"callback": remove_hosts,
	},
	# This is purely for the benefit of the helptext generator
	"Remove Hosts": {
		"command": ["remove-host", "remove-hosts"],
		"values": [ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("... ", "argument"),
			   ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Remove ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" from ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
	},
	"Set Global Variables": {
		"command": ["set-var", "set-vars"],
		"values": [ANSIThemeString("KEY", "argument"),
			   ANSIThemeString(":", "separator"),
			   ANSIThemeString("VALUE", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Set global ", "description"),
				ANSIThemeString("KEY", "argument"),
				ANSIThemeString(":", "separator"),
				ANSIThemeString("VALUE", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"extended_description": [
			[ANSIThemeString("Setting global variables is equivalent to setting variables", "description")],
			[ANSIThemeString("for the group “", "description"),
			 ANSIThemeString("all", "argument"),
			 ANSIThemeString("“.", "description")],
		],
		"min_args": 1,
		"max_args": 1,
		"callback": set_global_vars,
	},
	"Set Group Variables": {
		"command": ["set-group-var", "set-group-vars"],
		"values": [ANSIThemeString("KEY", "argument"),
			   ANSIThemeString(":", "separator"),
			   ANSIThemeString("VALUE", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("... ", "argument"),
			   ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Set ", "description"),
				ANSIThemeString("KEY", "argument"),
				ANSIThemeString(":", "separator"),
				ANSIThemeString("VALUE", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" for ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"min_args": 2,
		"max_args": 2,
		"callback": set_group_vars,
	},
	"Set Host Variables": {
		"command": ["set-host-var", "set-host-vars"],
		"values": [ANSIThemeString("KEY", "argument"),
			   ANSIThemeString(":", "separator"),
			   ANSIThemeString("VALUE", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("... ", "argument"),
			   ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Set ", "description"),
				ANSIThemeString("KEY", "argument"),
				ANSIThemeString(":", "separator"),
				ANSIThemeString("VALUE", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument"),
				ANSIThemeString(" for ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"min_args": 2,
		"max_args": 2,
		"callback": set_host_vars,
	},
	"Unset Global Variables": {
		"command": ["unset-var", "unset-vars"],
		"values": [ANSIThemeString("KEY", "argument")],
		"description": [ANSIThemeString("Unset global ", "description"),
				ANSIThemeString("KEY", "argument")],
		"extended_description": [
			[ANSIThemeString("Unsetting global variables is equivalent to unsetting variables", "description")],
			[ANSIThemeString("for the group “", "description"),
			 ANSIThemeString("all", "argument"),
			 ANSIThemeString("“.", "description")],
		],
		"min_args": 1,
		"max_args": 1,
		"callback": unset_global_vars,
	},
	"Unset Group Variables": {
		"command": ["unset-group-var", "unset-group-vars"],
		"values": [ANSIThemeString("KEY ", "argument"),
			   ANSIThemeString("GROUP", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Unset ", "description"),
				ANSIThemeString("KEY", "argument"),
				ANSIThemeString(" for ", "description"),
				ANSIThemeString("GROUP", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"min_args": 2,
		"max_args": 2,
		"callback": unset_group_vars,
	},
	"Unset Host Variables": {
		"command": ["unset-host-var", "unset-host-vars"],
		"values": [ANSIThemeString("KEY ", "argument"),
			   ANSIThemeString("HOST", "argument"),
			   ANSIThemeString(",", "separator"),
			   ANSIThemeString("...", "argument")],
		"description": [ANSIThemeString("Unset ", "description"),
				ANSIThemeString("KEY", "argument"),
				ANSIThemeString(" for ", "description"),
				ANSIThemeString("HOST", "argument"),
				ANSIThemeString(",", "separator"),
				ANSIThemeString("...", "argument")],
		"min_args": 2,
		"max_args": 2,
		"callback": unset_host_vars,
	},
	"spacer1": {
		"command": [""],
		"description": [ANSIThemeString("", "default")],
	},
}

def main() -> int:
	"""
	Main function for the program
	"""

	# Before doing anything else, make sure that the user is not running as root
	if os.geteuid() == 0:
		sys.exit("CRITICAL: This program should not be run as the root user; aborting.")

	# Then initialise the configuration file
	read_cmtconfig()

	command, options, args = parse_commandline(about.INVENTORY_PROGRAM_NAME, about.INVENTORY_PROGRAM_VERSION, PROGRAMDESCRIPTION, PROGRAMAUTHORS, sys.argv,
						   COMMANDLINE, default_command = "inventory", theme = DEFAULT_THEME_FILE)

	# cmtinv was called without any parameters; assuming inventory
	if command is None:
		command = inventory

	# Used by the ansible module
	ansible_configuration["ansible_forks"] = deep_get(cmtlib.cmtconfig, DictPath("Ansible#forks"), 10)
	ansible_configuration["ansible_user"] = deep_get(cmtlib.cmtconfig, DictPath("Ansible#ansible_user"))
	ansible_configuration["ansible_password"] = deep_get(cmtlib.cmtconfig, DictPath("Ansible#ansible_password"))
	ansible_configuration["disable_strict_host_key_checking"] = deep_get(cmtlib.cmtconfig, DictPath("Nodes#disablestricthostkeychecking"), False)

	return command(options, args)

if __name__ == "__main__":
	main()
